---
phase: 09-sharing-tv-mode-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/happy-share-renderer.ts
  - src/components/PositiveNewsFeedPanel.ts
  - src/styles/happy-theme.css
autonomous: true
requirements:
  - SHARE-01
  - SHARE-02
  - SHARE-03

must_haves:
  truths:
    - "User can tap a share button on any positive news card to generate a branded image card"
    - "The share card renders with warm gradient background, headline, category badge, source attribution, and HappyMonitor branding"
    - "The share card exports as a 1080x1080 PNG with watermark, downloadable or shareable via Web Share API"
  artifacts:
    - path: "src/services/happy-share-renderer.ts"
      provides: "Canvas 2D renderer for happy story cards from NewsItem data"
      exports: ["renderHappyShareCard"]
    - path: "src/components/PositiveNewsFeedPanel.ts"
      provides: "Share button on each positive news card with click handler"
      contains: "positive-card-share"
    - path: "src/styles/happy-theme.css"
      provides: "Share button styling and share modal overlay CSS"
      contains: "positive-card-share"
  key_links:
    - from: "src/components/PositiveNewsFeedPanel.ts"
      to: "src/services/happy-share-renderer.ts"
      via: "import renderHappyShareCard, called on share button click"
      pattern: "renderHappyShareCard"
    - from: "src/services/happy-share-renderer.ts"
      to: "canvas.toBlob()"
      via: "PNG export for Web Share API / clipboard / download fallback"
      pattern: "toBlob|toDataURL"
---

<objective>
Build the branded share card pipeline for positive news stories — a Canvas 2D renderer that generates warm, branded 1080x1080 PNG images from NewsItem data, and integrate a share button into every positive news card.

Purpose: Users want to share uplifting stories on social media with a beautiful branded card that represents HappyMonitor's positive aesthetic.

Output: `src/services/happy-share-renderer.ts` (Canvas 2D renderer), updated `PositiveNewsFeedPanel.ts` (share button + handler), updated `happy-theme.css` (share button + modal styles).
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/story-renderer.ts (existing Canvas 2D pattern to follow)
@src/components/StoryModal.ts (existing Web Share API + clipboard + download fallback pattern)
@src/services/story-share.ts (existing share URL construction)
@src/components/PositiveNewsFeedPanel.ts (target for share button integration)
@src/services/positive-classifier.ts (category labels and colors for badge rendering)
@src/styles/happy-theme.css (target for share button CSS)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create happy share card Canvas 2D renderer</name>
  <files>src/services/happy-share-renderer.ts</files>
  <action>
Create `src/services/happy-share-renderer.ts` that exports `renderHappyShareCard(item: NewsItem): Promise<HTMLCanvasElement>` following the existing `renderStoryToCanvas` pattern in `story-renderer.ts`.

**Canvas specs:**
- 1080x1080 square (social media optimized — works on Instagram, WhatsApp, LinkedIn, Twitter)
- Warm linear gradient background per category using these stops:
  - science-health: #E8F4FD → #C5DFF8
  - nature-wildlife: #E8F5E4 → #C5E8BE
  - humanity-kindness: #FDE8EE → #F5C5D5
  - innovation-tech: #FDF5E8 → #F5E2C0
  - climate-wins: #E4F5E8 → #BEE8C5
  - culture-community: #F0E8FD → #D8C5F5
- Category badge (pill shape) in top-left area with category accent color and white text, using label from `HAPPY_CATEGORY_LABELS`
- Category accent colors: science=#7BA5C4, nature=#6B8F5E, kindness=#C48B9F, innovation=#C4A35A, climate=#2d9a4e, culture=#8b5cf6
- Headline text: large, bold, dark (#2D3748), word-wrapped with manual line breaking (Canvas 2D has no auto-wrap — use `ctx.measureText()` to split into lines). Font: `700 48px Nunito, system-ui, sans-serif`. Max ~6 lines.
- Source attribution: smaller text below headline, muted color (#718096). Font: `400 26px Nunito, system-ui, sans-serif`.
- Date: below source, muted (#A0AEC0). Font: `400 22px Nunito, system-ui, sans-serif`.
- HappyMonitor branding at bottom: "HappyMonitor" in gold (#C4A35A) with sun emoji prefix, font `700 28px Nunito`. Below that, "happy.worldmonitor.app" in muted text.
- Subtle decorative element: thin accent-colored line (2px) across the bottom 20% of the card as a separator above branding.

**Critical:** Await font loading before rendering: `await document.fonts.load('700 48px Nunito'); await document.fonts.load('400 26px Nunito');` to prevent system font fallback.

**Also export** a helper `shareHappyCard(item: NewsItem): Promise<void>` that:
1. Calls `renderHappyShareCard(item)` to get the canvas
2. Converts to Blob via `canvas.toBlob('image/png')`
3. Creates a File object: `new File([blob], 'happymonitor-story.png', { type: 'image/png' })`
4. Tries Web Share API: `navigator.share({ text: headline, files: [file] })` if `navigator.canShare?.({ files: [file] })`
5. Falls back to clipboard: `navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])`
6. Final fallback: trigger download via anchor element with `a.download = 'happymonitor-story.png'`
Follow the exact same fallback chain from `StoryModal.ts` lines 128-147.

Do NOT include the news item image (RSS images are cross-origin and will taint the canvas). Text-only with gradient is the correct approach.

**Word-wrap helper:** Create a private `wrapText(ctx, text, maxWidth)` function that splits text into lines by measuring word-by-word with `ctx.measureText()`. Return string array of lines.
  </action>
  <verify>
`npx tsc --noEmit src/services/happy-share-renderer.ts` compiles without errors. The file exports `renderHappyShareCard` and `shareHappyCard`.
  </verify>
  <done>
A Canvas 2D renderer exists that produces a 1080x1080 branded PNG from any NewsItem with warm gradient, category badge, headline, source, date, and HappyMonitor watermark. A share helper handles Web Share API → clipboard → download fallback chain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add share button to positive news cards and wire handler</name>
  <files>src/components/PositiveNewsFeedPanel.ts, src/styles/happy-theme.css</files>
  <action>
**In `PositiveNewsFeedPanel.ts`:**

1. Import `shareHappyCard` from `@/services/happy-share-renderer`.
2. In the `renderCard(item: NewsItem)` method, add a share button inside the `.positive-card-body` div, after the `.positive-card-time` span:
```html
<button class="positive-card-share" aria-label="Share this story" data-idx="INDEX">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
    <polyline points="16 6 12 2 8 6"/>
    <line x1="12" y1="2" x2="12" y2="15"/>
  </svg>
</button>
```
Note: The share button is INSIDE the `<a>` card. To prevent the link navigation when clicking share, use `e.preventDefault(); e.stopPropagation();` in the click handler.

3. In the `renderCards` method (after setting innerHTML), attach a delegated click handler on `this.content` for `.positive-card-share` clicks. Use event delegation (single listener on content div) rather than per-button listeners. The handler should:
   - Call `e.preventDefault(); e.stopPropagation();` to prevent the `<a>` tag navigation
   - Find the item from the data-idx attribute on the button
   - Call `shareHappyCard(item)` (async, fire-and-forget with `.catch(() => {})`)
   - Add a brief visual feedback: toggle a `.shared` class on the button for 1.5s

4. Store a reference to the delegated handler so it can be removed on destroy. Or, since content is replaced on each render, just re-attach after innerHTML set.

**In `happy-theme.css`:**

Add styles for `.positive-card-share`:
- Position: absolute, top-right of `.positive-card-body` (the card body needs `position: relative`)
- Size: 32x32px circle
- Background: rgba(255,255,255,0.8), border: none
- Border-radius: 50%
- Display: flex, align-items: center, justify-content: center
- Color (stroke): var(--text-tertiary)
- Opacity: 0 by default, opacity: 1 on `.positive-card:hover .positive-card-share`
- Transition: opacity 0.2s, background 0.2s
- Hover state: background rgba(255,255,255,1), color var(--yellow)
- `.shared` state: color var(--green), transform: scale(1.1), transition 0.15s
- Cursor: pointer
- z-index: 2 (above the card link)

Also add `.positive-card-body { position: relative; }` if not already set.

Dark mode: `[data-variant='happy'][data-theme='dark'] .positive-card-share` — background rgba(30,30,30,0.8), hover background rgba(50,50,50,1).
  </action>
  <verify>
`npm run build:happy` succeeds. In browser, hovering a positive news card shows a share icon in the top-right of the card body. Clicking the share icon does NOT navigate to the article link. Instead it generates a PNG share card.
  </verify>
  <done>
Every positive news card has a share button that appears on hover. Clicking it generates a branded PNG image card and triggers the Web Share API (or clipboard/download fallback). The card link navigation is properly prevented when sharing.
  </done>
</task>

</tasks>

<verification>
1. `npm run build:happy` completes without errors
2. In the happy variant, each positive news card shows a share icon on hover
3. Clicking the share icon generates a 1080x1080 PNG with warm gradient, headline, category badge, and HappyMonitor branding
4. On mobile (or with Web Share API support), the native share sheet appears with the image
5. On desktop without Web Share API, the image is copied to clipboard or downloaded
6. The article link is NOT followed when clicking the share button
</verification>

<success_criteria>
- `renderHappyShareCard()` produces a canvas with correct dimensions, gradient, text layout, and branding
- `shareHappyCard()` handles the full share flow with 3-tier fallback (share → clipboard → download)
- Share button appears on all positive news cards with proper hover/click behavior
- No cross-origin canvas tainting (text-only cards, no external images)
</success_criteria>

<output>
After completion, create `.planning/phases/09-sharing-tv-mode-polish/09-01-SUMMARY.md`
</output>
