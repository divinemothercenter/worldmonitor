---
phase: 09-sharing-tv-mode-polish
plan: 03
type: execute
wave: 2
depends_on:
  - "09-02"
files_modified:
  - src/services/celebration.ts
  - src/App.ts
autonomous: true
requirements:
  - THEME-06

must_haves:
  truths:
    - "Milestone moments (species recovery announced, renewable energy record) trigger celebration animations via canvas-confetti"
    - "Confetti fires at most once per milestone per session (no repeated celebrations on data refresh)"
    - "Celebration animations respect prefers-reduced-motion and are disabled when that media query matches"
  artifacts:
    - path: "src/services/celebration.ts"
      provides: "Celebration service wrapping canvas-confetti with milestone detection and session dedup"
      exports: ["celebrate", "checkMilestones"]
    - path: "src/App.ts"
      provides: "Milestone check calls in data loading pipelines for conservation and renewable energy panels"
      contains: "checkMilestones"
  key_links:
    - from: "src/App.ts"
      to: "src/services/celebration.ts"
      via: "import checkMilestones, called after panel data loads"
      pattern: "checkMilestones"
    - from: "src/services/celebration.ts"
      to: "canvas-confetti"
      via: "import confetti, called with warm color palette and useWorker"
      pattern: "confetti"
---

<objective>
Add celebration animations that fire when milestone data events are detected — species recovery announcements, renewable energy records, and similar positive breakthroughs. Uses canvas-confetti with session-level deduplication so celebrations feel special, not repetitive.

Purpose: Milestone moments deserve a brief visual celebration that reinforces the positive emotional impact of the dashboard. "Warm, not birthday party" — subtle, elegant, and only for genuinely notable events.

Output: `src/services/celebration.ts` (confetti wrapper + milestone detection), updated `src/App.ts` (milestone check wiring in data pipelines).
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-sharing-tv-mode-polish/09-02-SUMMARY.md
@src/App.ts (data loading pipelines — loadConservationData, loadRenewableData, refreshAll)
@src/data/conservation-wins.json (species data with status badges)
@src/services/renewable-energy-data.ts (renewable percentage data)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install canvas-confetti and create celebration service</name>
  <files>src/services/celebration.ts</files>
  <action>
**Install dependency:**
```bash
npm install canvas-confetti
npm install -D @types/canvas-confetti
```

**Create `src/services/celebration.ts`:**

```typescript
import confetti from 'canvas-confetti';
```

**Constants:**
- `REDUCED_MOTION`: `window.matchMedia('(prefers-reduced-motion: reduce)').matches` — checked once at module load.
- `WARM_COLORS`: `['#6B8F5E', '#C4A35A', '#7BA5C4', '#8BAF7A', '#E8B96E', '#7FC4C4']` — nature-inspired palette matching happy theme.
- `celebrated`: `Set<string>` — session-level dedup. Stores milestone keys that have already been celebrated this session.

**`celebrate(type: 'milestone' | 'record' = 'milestone'): void`**
- If `REDUCED_MOTION`, return immediately.
- For `milestone`: 40 particles, spread 60, origin { y: 0.7 }, colors WARM_COLORS, `disableForReducedMotion: true`.
- For `record`: 80 particles, spread 90, origin { y: 0.6 }, same colors. Fire twice with 300ms delay for a "double burst" effect.
- Use `void confetti(opts)` (fire-and-forget, no await needed).
- Do NOT use `useWorker: true` in the simple `confetti()` call (it only works with `confetti.create()` on a specific canvas). The default `confetti()` uses a shared overlay canvas that auto-creates and auto-removes.

**`checkMilestones(data: MilestoneData): void`**
- Define `MilestoneData` interface:
  ```typescript
  export interface MilestoneData {
    speciesRecoveries?: Array<{ name: string; status: string }>;
    renewablePercent?: number;
    newSpeciesCount?: number;
  }
  ```
- **Species recovery milestone:** For each species with `status === 'Recovered'` or `status === 'Stabilized'`, create key `species:${name}`. If not in `celebrated` set, add it and call `celebrate('milestone')`.
- **Renewable energy record:** If `renewablePercent` crosses a 5% threshold (e.g., 30%, 35%, 40%...), create key `renewable:${Math.floor(renewablePercent / 5) * 5}`. If not in `celebrated` set, add it and call `celebrate('record')`.
- **New species count:** If `newSpeciesCount` is defined and > 0, create key `species-count:${newSpeciesCount}`. If not in `celebrated`, add and celebrate('milestone').
- Only fire ONE celebration per `checkMilestones` call (first matching milestone wins). This prevents multiple confetti bursts overlapping.

**`resetCelebrations(): void`** — Clears the `celebrated` set. Exported for testing purposes.

**Key design decisions:**
- Session-level dedup (Set in memory) rather than sessionStorage — simpler, no serialization overhead, correctly resets on tab close.
- One celebration per check call prevents visual overload.
- "Warm, not birthday party": particle counts are moderate (40–80), colors are nature tones, no emoji confetti.
  </action>
  <verify>
`npx tsc --noEmit src/services/celebration.ts` compiles. `canvas-confetti` and `@types/canvas-confetti` are in package.json. The module exports `celebrate`, `checkMilestones`, `resetCelebrations`, and `MilestoneData`.
  </verify>
  <done>
A celebration service exists that wraps canvas-confetti with warm nature-inspired colors, session-level deduplication, reduced-motion support, and milestone detection for species recovery and renewable energy records.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire milestone checks into App.ts data loading pipelines</name>
  <files>src/App.ts</files>
  <action>
**Import:** Add `import { checkMilestones } from '@/services/celebration';` to App.ts imports.

**Wire into conservation data loading:**

Find where species/conservation data is loaded and passed to the SpeciesComebackPanel (in the `refreshAll()` method, inside the `SITE_VARIANT === 'happy'` block). After the data is loaded and passed to the panel, add a milestone check:

```typescript
// After: this.speciesComebackPanel?.setData(speciesData);
if (SITE_VARIANT === 'happy' && speciesData) {
  checkMilestones({
    speciesRecoveries: speciesData.map(s => ({ name: s.commonName, status: s.status })),
    newSpeciesCount: speciesData.length,
  });
}
```

**Wire into renewable energy data loading:**

Find where renewable energy data is loaded and passed to the RenewableEnergyPanel. After the data is set, add:

```typescript
// After: this.renewableEnergyPanel?.setData(renewableData);
if (SITE_VARIANT === 'happy' && renewableData?.global?.latestValue) {
  checkMilestones({
    renewablePercent: renewableData.global.latestValue,
  });
}
```

**Important notes:**
- These checks run every refresh cycle, but the session dedup in `celebration.ts` ensures confetti only fires once per milestone per session.
- Do NOT add celebration checks to non-happy variants. Gate all calls behind `SITE_VARIANT === 'happy'`.
- Place the `checkMilestones` call AFTER the panel `setData()` call (data should be visible before celebration fires).
- The calls should be fire-and-forget — `checkMilestones` is synchronous (confetti itself is fire-and-forget).
- Adapt the exact data shapes to match the actual variables and types available at the call sites. Read the surrounding code to understand the exact variable names used for species data (may be from `fetchConservationWins()`) and renewable data (may be from `fetchRenewableData()` or World Bank response).
  </action>
  <verify>
`npm run build:happy` succeeds. In the happy variant, after data loads, if species data contains "Recovered" status entries or renewable percentage crosses a 5% threshold, confetti fires once. Refreshing data does NOT re-trigger the same celebration.
  </verify>
  <done>
Milestone detection is wired into both conservation and renewable energy data pipelines. Confetti fires on species recovery and renewable energy milestones, with session dedup preventing repeat celebrations.
  </done>
</task>

</tasks>

<verification>
1. `npm run build:happy` completes without errors
2. `canvas-confetti` appears in package.json dependencies
3. On first data load in happy variant, confetti fires for species with "Recovered" status
4. Confetti does NOT fire again on subsequent data refreshes for the same milestone
5. Confetti uses warm nature-inspired colors (greens, golds, blues), not party colors
6. With `prefers-reduced-motion: reduce`, no confetti fires
7. Particle count is moderate (40–80) — visible but not overwhelming
</verification>

<success_criteria>
- canvas-confetti installed and working
- celebrate() fires confetti with warm colors and reduced-motion support
- checkMilestones() detects species recovery and renewable energy records
- Session dedup prevents repeat celebrations
- Wired into App.ts data pipelines gated by SITE_VARIANT === 'happy'
- "Warm, not birthday party" — moderate particles, nature palette
</success_criteria>

<output>
After completion, create `.planning/phases/09-sharing-tv-mode-polish/09-03-SUMMARY.md`
</output>
