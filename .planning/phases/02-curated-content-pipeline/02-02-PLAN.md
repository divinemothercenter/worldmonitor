---
phase: 02-curated-content-pipeline
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/services/positive-classifier.ts
  - src/types/index.ts
  - src/config/feeds.ts
  - src/config/variants/happy.ts
autonomous: true
requirements:
  - FEED-04

must_haves:
  truths:
    - "Every news story ingested by the happy variant is tagged with one of the six content categories"
    - "Source-based feeds (GNN Science, GNN Animals, etc.) are pre-mapped to categories without keyword scanning"
    - "General positive feeds fall back to keyword-based classification"
    - "The happy variant dashboard shows positive news stories (not geopolitical feeds) when loaded"
  artifacts:
    - path: "src/services/positive-classifier.ts"
      provides: "HappyContentCategory type, keyword classifier, source-based pre-mapping, HAPPY_CATEGORY_LABELS"
      contains: "classifyNewsItem"
    - path: "src/types/index.ts"
      provides: "happyCategory field on NewsItem interface"
      contains: "happyCategory"
  key_links:
    - from: "src/services/positive-classifier.ts"
      to: "src/types/index.ts"
      via: "HappyContentCategory type used by NewsItem.happyCategory"
      pattern: "happyCategory.*HappyContentCategory"
    - from: "src/config/feeds.ts"
      to: "src/services/positive-classifier.ts"
      via: "Feed names match SOURCE_CATEGORY_MAP keys for pre-classification"
      pattern: "GNN Science.*science-health"
---

<objective>
Create the content category classifier for positive news stories and wire it into the happy variant's data pipeline so every ingested story gets a content category tag.

Purpose: Content categories (Science & Health, Nature & Wildlife, etc.) enable downstream UI filtering in Phase 3 and give stories meaningful groupings. Without classification, stories are just an undifferentiated stream. This plan also ensures the happy variant's FEEDS are actually consumed by the data loading pipeline (addressing Pitfall 4 from research -- invisible pipeline).

Output: `positive-classifier.ts` service module with keyword-based classification, `NewsItem.happyCategory` type extension, and happy variant feed consumption verified end-to-end.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-curated-content-pipeline/02-RESEARCH.md
@.planning/phases/02-curated-content-pipeline/02-01-SUMMARY.md
@src/services/threat-classifier.ts
@src/types/index.ts
@src/config/feeds.ts
@src/config/variants/happy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create positive content classifier and extend NewsItem type</name>
  <files>
    src/services/positive-classifier.ts
    src/types/index.ts
  </files>
  <action>
**Step 1: Create `src/services/positive-classifier.ts`**

Create a new keyword-based classifier following the same pattern as `src/services/threat-classifier.ts`. The classifier has two paths: source-based pre-mapping (fast) and keyword-based fallback.

```typescript
// src/services/positive-classifier.ts

export type HappyContentCategory =
  | 'science-health'
  | 'nature-wildlife'
  | 'humanity-kindness'
  | 'innovation-tech'
  | 'climate-wins'
  | 'culture-community';

export const HAPPY_CATEGORY_LABELS: Record<HappyContentCategory, string> = {
  'science-health': 'Science & Health',
  'nature-wildlife': 'Nature & Wildlife',
  'humanity-kindness': 'Humanity & Kindness',
  'innovation-tech': 'Innovation & Tech',
  'climate-wins': 'Climate Wins',
  'culture-community': 'Culture & Community',
};

export const HAPPY_CATEGORY_ALL: HappyContentCategory[] = [
  'science-health',
  'nature-wildlife',
  'humanity-kindness',
  'innovation-tech',
  'climate-wins',
  'culture-community',
];
```

**Source-based pre-classification** (feed name -> category, checked before keywords):
```typescript
const SOURCE_CATEGORY_MAP: Record<string, HappyContentCategory> = {
  'GNN Science': 'science-health',
  'GNN Health': 'science-health',
  'GNN Animals': 'nature-wildlife',
  'GNN Heroes': 'humanity-kindness',
};
```

**Keyword classification** with priority ordering. Use an array of `[keyword, category]` tuples (NOT a flat object) so iteration order is guaranteed and more specific keywords are checked first:

```typescript
// Priority-ordered: most specific keywords first to avoid mis-classification
// (e.g., "endangered species" should match nature before generic "technology")
const CATEGORY_KEYWORDS: Array<[string, HappyContentCategory]> = [
  // Science & Health (most specific first)
  ['clinical trial', 'science-health'],
  ['study finds', 'science-health'],
  ['researchers', 'science-health'],
  ['scientists', 'science-health'],
  ['breakthrough', 'science-health'],
  ['discovery', 'science-health'],
  ['cure', 'science-health'],
  ['vaccine', 'science-health'],
  ['treatment', 'science-health'],
  ['medical', 'science-health'],
  ['therapy', 'science-health'],
  ['cancer', 'science-health'],
  ['disease', 'science-health'],

  // Nature & Wildlife
  ['endangered species', 'nature-wildlife'],
  ['conservation', 'nature-wildlife'],
  ['wildlife', 'nature-wildlife'],
  ['species', 'nature-wildlife'],
  ['marine', 'nature-wildlife'],
  ['reef', 'nature-wildlife'],
  ['forest', 'nature-wildlife'],
  ['whale', 'nature-wildlife'],
  ['bird', 'nature-wildlife'],
  ['animal', 'nature-wildlife'],

  // Climate Wins (before innovation so "solar" matches climate, not tech)
  ['renewable', 'climate-wins'],
  ['solar', 'climate-wins'],
  ['wind energy', 'climate-wins'],
  ['wind farm', 'climate-wins'],
  ['electric vehicle', 'climate-wins'],
  ['emissions', 'climate-wins'],
  ['carbon', 'climate-wins'],
  ['clean energy', 'climate-wins'],
  ['climate', 'climate-wins'],
  ['green hydrogen', 'climate-wins'],

  // Innovation & Tech
  ['robot', 'innovation-tech'],
  ['technology', 'innovation-tech'],
  ['startup', 'innovation-tech'],
  ['invention', 'innovation-tech'],
  ['innovation', 'innovation-tech'],
  ['engineering', 'innovation-tech'],
  ['3d print', 'innovation-tech'],
  ['ai', 'innovation-tech'],

  // Humanity & Kindness
  ['volunteer', 'humanity-kindness'],
  ['donated', 'humanity-kindness'],
  ['charity', 'humanity-kindness'],
  ['rescued', 'humanity-kindness'],
  ['hero', 'humanity-kindness'],
  ['kindness', 'humanity-kindness'],
  ['helping', 'humanity-kindness'],
  ['community', 'humanity-kindness'],

  // Culture & Community
  ['art', 'culture-community'],
  ['music', 'culture-community'],
  ['festival', 'culture-community'],
  ['cultural', 'culture-community'],
  ['education', 'culture-community'],
  ['school', 'culture-community'],
  ['library', 'culture-community'],
  ['museum', 'culture-community'],
];
```

**Classifier functions:**
```typescript
export function classifyPositiveContent(title: string): HappyContentCategory {
  const lower = title.toLowerCase();
  for (const [keyword, category] of CATEGORY_KEYWORDS) {
    if (lower.includes(keyword)) return category;
  }
  return 'humanity-kindness'; // default for curated positive sources
}

export function classifyNewsItem(source: string, title: string): HappyContentCategory {
  // Fast path: source name maps directly to a category
  const sourceCategory = SOURCE_CATEGORY_MAP[source];
  if (sourceCategory) return sourceCategory;
  // Slow path: keyword classification from title
  return classifyPositiveContent(title);
}
```

**Step 2: Extend NewsItem in `src/types/index.ts`**

Add `happyCategory` optional field to the `NewsItem` interface:

```typescript
export interface NewsItem {
  source: string;
  title: string;
  link: string;
  pubDate: Date;
  isAlert: boolean;
  monitorColor?: string;
  tier?: number;
  threat?: import('@/services/threat-classifier').ThreatClassification;
  lat?: number;
  lon?: number;
  locationName?: string;
  lang?: string;
  // Happy variant: positive content category
  happyCategory?: import('@/services/positive-classifier').HappyContentCategory;
}
```

Use the same `import()` type pattern already used for `threat` field to avoid circular imports.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors.
2. File `src/services/positive-classifier.ts` exists and exports `classifyNewsItem`, `HappyContentCategory`, `HAPPY_CATEGORY_LABELS`, `HAPPY_CATEGORY_ALL`.
3. `src/types/index.ts` has `happyCategory` on `NewsItem`.
4. `classifyNewsItem('GNN Science', 'anything')` returns `'science-health'` (source-based).
5. `classifyNewsItem('Good News Network', 'Solar panels breakthrough')` returns `'climate-wins'` (keyword-based).
  </verify>
  <done>
`positive-classifier.ts` exists with HappyContentCategory type, 6 categories, source-based pre-mapping for GNN feeds, priority-ordered keyword classification for general feeds. `NewsItem.happyCategory` field added to types. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up happy variant config and verify feed wiring</name>
  <files>
    src/config/variants/happy.ts
    src/config/feeds.ts
  </files>
  <action>
**Step 1: Update happy.ts to remove the now-obsolete FEEDS placeholder**

In `src/config/variants/happy.ts`, the `FEEDS` export is now dead code because feeds are handled by `HAPPY_FEEDS` in `src/config/feeds.ts` (from Plan 02-01). Remove the placeholder:

```typescript
// Remove the entire FEEDS block:
// export const FEEDS: Record<string, Feed[]> = {
//   positive: [],
// };
```

Remove the `Feed` type from the import line since it is no longer used. Keep the remaining exports (`DEFAULT_PANELS`, `DEFAULT_MAP_LAYERS`, etc.) intact.

**Step 2: Add SOURCE_TIERS entries for happy feeds if not already present**

Verify that `SOURCE_TIERS` in `src/config/feeds.ts` includes entries for all happy feed names (added in Plan 02-01 Task 1). If any are missing, add them. The tier assignments should be:
- Tier 2: Good News Network, Positive.News, Reasons to be Cheerful, Optimist Daily
- Tier 3: GNN Science, GNN Animals, GNN Health, GNN Heroes

**Step 3: Verify end-to-end data flow**

The data flow for the happy variant should be:
1. `src/config/variant.ts` -- `SITE_VARIANT === 'happy'`
2. `src/config/feeds.ts` -- `FEEDS = HAPPY_FEEDS` when variant is happy
3. `src/App.ts` line ~3426 -- `Object.entries(FEEDS)` iterates happy categories
4. `loadNewsCategory()` calls `fetchCategoryFeeds()` for each category
5. Stories flow into `NewsPanel` instances

Verify this chain by reading the relevant code paths. The `loadNews()` method in App.ts already iterates `Object.entries(FEEDS)` dynamically -- no App.ts changes needed because the FEEDS export already routes to HAPPY_FEEDS.

The key verification is that `Object.keys(FEEDS)` for the happy variant returns `['positive', 'science', 'nature', 'health', 'inspiring']` (the HAPPY_FEEDS keys), NOT the FULL_FEEDS keys like `['politics', 'tech', ...]`.

**Do NOT modify App.ts** -- the existing dynamic iteration handles any FEEDS record shape. The category classification (`happyCategory` tagging on NewsItem) will be wired in Phase 3 when the LiveNewsPanel consumes the stories, because that's a UI concern. Phase 2 establishes the data pipeline; Phase 3 wires the display.
  </action>
  <verify>
1. `npx tsc --noEmit` passes.
2. `src/config/variants/happy.ts` no longer exports a `FEEDS` record.
3. Grep `src/config/feeds.ts` for `happy` to confirm HAPPY_FEEDS is in the FEEDS export ternary.
4. Run `VITE_VARIANT=happy npx vite build --mode development 2>&1 | tail -5` to verify the happy variant builds without errors (a quick sanity check -- not a full prod build).
  </verify>
  <done>
Happy variant config cleaned up (dead FEEDS placeholder removed). HAPPY_FEEDS correctly routed via FEEDS export. Happy variant build succeeds. The data loading path in App.ts dynamically iterates HAPPY_FEEDS categories when `SITE_VARIANT === 'happy'`.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors
2. `positive-classifier.ts` exports HappyContentCategory type with 6 categories
3. `classifyNewsItem()` uses source pre-mapping before keyword fallback
4. `NewsItem.happyCategory` field exists in types
5. Happy variant config no longer has duplicate FEEDS export
6. Happy variant build succeeds with positive feeds configured
</verification>

<success_criteria>
- Content category classifier exists with 6 defined categories matching ROADMAP requirements
- Every story can be classified: source-based mapping for GNN category feeds, keyword-based for general positive feeds
- NewsItem type extended with optional happyCategory field
- Happy variant config is clean (no dead code)
- Happy variant builds successfully and loads HAPPY_FEEDS (not FULL_FEEDS)
</success_criteria>

<output>
After completion, create `.planning/phases/02-curated-content-pipeline/02-02-SUMMARY.md`
</output>
