---
phase: 02-curated-content-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/feeds.ts
  - proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto
  - server/worldmonitor/intelligence/v1/search-gdelt-documents.ts
  - src/generated/client/worldmonitor/intelligence/v1/service_client.ts
  - src/generated/server/worldmonitor/intelligence/v1/service_server.ts
  - src/services/gdelt-intel.ts
autonomous: true
requirements:
  - FEED-01
  - FEED-03

must_haves:
  truths:
    - "Happy variant FEEDS record contains at least 5 positive RSS feed entries across multiple categories"
    - "GDELT handler accepts tone_filter and sort parameters and appends them to the GDELT API URL"
    - "Client-side fetchPositiveGdeltArticles() function queries GDELT with tone>5 and ToneDesc sort"
  artifacts:
    - path: "src/config/feeds.ts"
      provides: "HAPPY_FEEDS record with positive RSS feeds and FEEDS export updated for happy variant"
      contains: "HAPPY_FEEDS"
    - path: "proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto"
      provides: "tone_filter and sort fields on SearchGdeltDocumentsRequest"
      contains: "tone_filter"
    - path: "server/worldmonitor/intelligence/v1/search-gdelt-documents.ts"
      provides: "Handler passes tone_filter and sort to GDELT API URL"
      contains: "toneFilter"
    - path: "src/services/gdelt-intel.ts"
      provides: "POSITIVE_GDELT_TOPICS array and fetchPositiveGdeltArticles helper"
      contains: "POSITIVE_GDELT_TOPICS"
  key_links:
    - from: "src/config/feeds.ts"
      to: "src/App.ts"
      via: "FEEDS export consumed by loadNews()"
      pattern: "SITE_VARIANT.*happy.*HAPPY_FEEDS"
    - from: "proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto"
      to: "src/generated/client/worldmonitor/intelligence/v1/service_client.ts"
      via: "buf generate codegen"
      pattern: "toneFilter.*string"
    - from: "src/services/gdelt-intel.ts"
      to: "src/generated/client/worldmonitor/intelligence/v1/service_client.ts"
      via: "IntelligenceServiceClient.searchGdeltDocuments with toneFilter param"
      pattern: "toneFilter.*tone"
---

<objective>
Populate the happy variant's RSS feed configuration with verified positive news sources and extend the GDELT integration with tone filtering for positive article retrieval.

Purpose: Establish the data ingest layer -- positive RSS feeds and GDELT positive tone queries -- so content flows into the happy variant's news pipeline. Without this, the happy variant falls back to FULL_FEEDS (geopolitical news), which defeats the purpose.

Output: Happy variant FEEDS record with 8+ positive feeds, GDELT proto extended with tone_filter/sort fields, handler updated, client-side positive GDELT helper function and topic definitions.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-curated-content-pipeline/02-RESEARCH.md
@src/config/feeds.ts
@src/config/variant.ts
@src/config/variants/happy.ts
@proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto
@server/worldmonitor/intelligence/v1/search-gdelt-documents.ts
@src/services/gdelt-intel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add positive RSS feeds to happy variant feed configuration</name>
  <files>src/config/feeds.ts</files>
  <action>
Add a `HAPPY_FEEDS` record to `src/config/feeds.ts` following the same pattern as `FULL_FEEDS`, `TECH_FEEDS`, and `FINANCE_FEEDS`. Use the existing `rss()` helper for proxy URLs.

Define these feed categories with verified URLs:

```typescript
const HAPPY_FEEDS: Record<string, Feed[]> = {
  positive: [
    { name: 'Good News Network', url: rss('https://www.goodnewsnetwork.org/feed/') },
    { name: 'Positive.News', url: rss('https://www.positive.news/feed/') },
    { name: 'Reasons to be Cheerful', url: rss('https://reasonstobecheerful.world/feed/') },
    { name: 'Optimist Daily', url: rss('https://www.optimistdaily.com/feed/') },
  ],
  science: [
    { name: 'GNN Science', url: rss('https://www.goodnewsnetwork.org/category/news/science/feed/') },
  ],
  nature: [
    { name: 'GNN Animals', url: rss('https://www.goodnewsnetwork.org/category/news/animals/feed/') },
  ],
  health: [
    { name: 'GNN Health', url: rss('https://www.goodnewsnetwork.org/category/news/health/feed/') },
  ],
  inspiring: [
    { name: 'GNN Heroes', url: rss('https://www.goodnewsnetwork.org/category/news/inspiring/feed/') },
  ],
};
```

That gives 8 feeds across 5 categories (exceeding the "at least 5" success criterion).

Then update the `FEEDS` export on line 936 to include the happy variant:

```typescript
export const FEEDS = SITE_VARIANT === 'tech'
  ? TECH_FEEDS
  : SITE_VARIANT === 'finance'
    ? FINANCE_FEEDS
    : SITE_VARIANT === 'happy'
      ? HAPPY_FEEDS
      : FULL_FEEDS;
```

Also add happy source tiers to `SOURCE_TIERS`:
```typescript
// Tier 2 - Positive News Sources (Happy variant)
'Good News Network': 2,
'Positive.News': 2,
'Reasons to be Cheerful': 2,
'Optimist Daily': 2,
'GNN Science': 3,
'GNN Animals': 3,
'GNN Health': 3,
'GNN Heroes': 3,
```

Do NOT add SunnySkyz, The Better India, or Future Crunch -- their RSS URLs are unverified per research. Only use verified feed URLs.

Do NOT modify the shared `fetchFeed()` or `fetchCategoryFeeds()` functions. Happy feeds use the same pipeline as all other variants.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Grep for `HAPPY_FEEDS` in feeds.ts to confirm it exists. Grep the FEEDS export line to confirm happy variant is included in the ternary.
  </verify>
  <done>
`HAPPY_FEEDS` record exists with 8 feeds across 5 categories (positive, science, nature, health, inspiring). The `FEEDS` export includes `SITE_VARIANT === 'happy' ? HAPPY_FEEDS` in the variant conditional. Source tiers assigned for all happy feeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend GDELT proto and handler with tone filter support</name>
  <files>
    proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto
    server/worldmonitor/intelligence/v1/search-gdelt-documents.ts
    src/services/gdelt-intel.ts
  </files>
  <action>
**Step 1: Extend the proto**

In `proto/worldmonitor/intelligence/v1/search_gdelt_documents.proto`, add two new fields to `SearchGdeltDocumentsRequest`:

```protobuf
message SearchGdeltDocumentsRequest {
  string query = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.min_len = 1
  ];
  int32 max_records = 2 [
    (buf.validate.field).int32.gte = 1,
    (buf.validate.field).int32.lte = 250
  ];
  string timespan = 3;
  // Tone filter appended to query (e.g., "tone>5" for positive, "tone<-5" for negative).
  // Left empty to skip tone filtering.
  string tone_filter = 4;
  // Sort mode: "DateDesc" (default), "ToneDesc", "ToneAsc", "HybridRel".
  string sort = 5;
}
```

**Step 2: Run buf generate**

```bash
cd proto && buf generate
```

This regenerates the TypeScript client and server types in `src/generated/`.

**Step 3: Update the handler**

In `server/worldmonitor/intelligence/v1/search-gdelt-documents.ts`, modify `searchGdeltDocuments()`:

1. After the existing `const query = req.query;` line, make query mutable and append tone filter:
```typescript
let query = req.query;
if (req.toneFilter) {
  query = `${query} ${req.toneFilter}`;
}
```

2. Change the sort parameter from hardcoded `'date'` to use `req.sort`:
```typescript
gdeltUrl.searchParams.set('sort', req.sort || 'date');
```

**Step 4: Add positive GDELT topics and fetch helper to client**

In `src/services/gdelt-intel.ts`:

1. Add `POSITIVE_GDELT_TOPICS` array (following `INTEL_TOPICS` pattern):
```typescript
export const POSITIVE_GDELT_TOPICS: IntelTopic[] = [
  {
    id: 'science-breakthroughs',
    name: 'Science Breakthroughs',
    query: '(breakthrough OR discovery OR "new treatment" OR "clinical trial success") sourcelang:eng',
    icon: '',
    description: 'Scientific discoveries and medical advances',
  },
  {
    id: 'climate-progress',
    name: 'Climate Progress',
    query: '(renewable energy record OR "solar installation" OR "wind farm" OR "emissions decline" OR "green hydrogen") sourcelang:eng',
    icon: '',
    description: 'Renewable energy milestones and climate wins',
  },
  {
    id: 'conservation-wins',
    name: 'Conservation Wins',
    query: '(species recovery OR "population rebound" OR "conservation success" OR "habitat restored" OR "marine sanctuary") sourcelang:eng',
    icon: '',
    description: 'Wildlife recovery and habitat restoration',
  },
  {
    id: 'humanitarian-progress',
    name: 'Humanitarian Progress',
    query: '(poverty decline OR "literacy rate" OR "vaccination campaign" OR "peace agreement" OR "humanitarian aid") sourcelang:eng',
    icon: '',
    description: 'Poverty reduction, education, and peace',
  },
  {
    id: 'innovation',
    name: 'Innovation',
    query: '("clean technology" OR "AI healthcare" OR "3D printing" OR "electric vehicle" OR "fusion energy") sourcelang:eng',
    icon: '',
    description: 'Technology for good and clean innovation',
  },
];
```

2. Add `fetchPositiveGdeltArticles()` function that uses the new `toneFilter` and `sort` fields:
```typescript
export async function fetchPositiveGdeltArticles(
  query: string,
  toneFilter = 'tone>5',
  sort = 'ToneDesc',
  maxrecords = 15,
  timespan = '72h',
): Promise<GdeltArticle[]> {
  const cacheKey = `positive:${query}:${toneFilter}:${sort}:${maxrecords}:${timespan}`;
  const cached = articleCache.get(cacheKey);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.articles;
  }

  const resp = await gdeltBreaker.execute(async () => {
    return client.searchGdeltDocuments({
      query,
      maxRecords: maxrecords,
      timespan,
      toneFilter,
      sort,
    });
  }, emptyGdeltFallback);

  if (resp.error) {
    console.warn(`[GDELT-Intel] Positive RPC error: ${resp.error}`);
    return cached?.articles || [];
  }

  const articles: GdeltArticle[] = (resp.articles || []).map(toGdeltArticle);
  articleCache.set(cacheKey, { articles, timestamp: Date.now() });
  return articles;
}
```

3. Add `fetchPositiveTopicIntelligence()` helpers:
```typescript
export async function fetchPositiveTopicIntelligence(topic: IntelTopic): Promise<TopicIntelligence> {
  const articles = await fetchPositiveGdeltArticles(topic.query);
  return { topic, articles, fetchedAt: new Date() };
}

export async function fetchAllPositiveTopicIntelligence(): Promise<TopicIntelligence[]> {
  const results = await Promise.allSettled(
    POSITIVE_GDELT_TOPICS.map(topic => fetchPositiveTopicIntelligence(topic))
  );
  return results
    .filter((r): r is PromiseFulfilledResult<TopicIntelligence> => r.status === 'fulfilled')
    .map(r => r.value);
}
```

Ensure the existing `fetchGdeltArticles()` function continues to work unchanged (backward compatible -- the new fields default to empty string which the handler ignores).
  </action>
  <verify>
1. `cd proto && buf generate` succeeds without errors.
2. `npx tsc --noEmit` passes.
3. Grep `src/generated/client/worldmonitor/intelligence/v1/service_client.ts` for `toneFilter` to confirm codegen included the new fields.
4. Grep `server/worldmonitor/intelligence/v1/search-gdelt-documents.ts` for `toneFilter` to confirm handler reads the field.
5. Grep `src/services/gdelt-intel.ts` for `POSITIVE_GDELT_TOPICS` and `fetchPositiveGdeltArticles`.
  </verify>
  <done>
Proto has `tone_filter` (field 4) and `sort` (field 5) on `SearchGdeltDocumentsRequest`. Handler appends `toneFilter` to query string and uses `sort` parameter. Generated TypeScript types include `toneFilter` and `sort` fields. Client-side `fetchPositiveGdeltArticles()` uses `tone>5` and `ToneDesc` sort by default. Five positive GDELT topic queries defined in `POSITIVE_GDELT_TOPICS`.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors
2. `HAPPY_FEEDS` in feeds.ts has 8+ feed entries across 5 categories
3. `FEEDS` export routes happy variant to `HAPPY_FEEDS` (not FULL_FEEDS)
4. Proto codegen succeeded -- `toneFilter` and `sort` in generated client types
5. Handler appends toneFilter to GDELT query and uses sort parameter
6. Existing `fetchGdeltArticles()` still works (backward compatible)
7. `fetchPositiveGdeltArticles()` passes toneFilter and sort to client
</verification>

<success_criteria>
- At least 5 dedicated positive RSS feeds configured for the happy variant with verified URLs
- GDELT handler accepts and applies tone_filter parameter (e.g., "tone>5")
- Client-side helper for positive GDELT queries exists with configurable tone threshold
- All existing non-happy variant functionality unchanged (backward compatible)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-curated-content-pipeline/02-01-SUMMARY.md`
</output>
